#!/bin/sh
# Code formatting hook - formats source code files
# Uses appropriate formatter based on project type

. .githooks/lib/common.sh

echo "    ðŸŽ¨ Formatting code..."
files_changed=false

# Format TypeScript/JavaScript with Deno
if command -v deno >/dev/null 2>&1; then
    log_info "Formatting with deno fmt..."
    # Use deno fmt without --ext to respect deno.json configuration
    if deno fmt; then
        # Check if any supported files were modified (deno handles exclusions)
        if files_modified '*.ts *.js *.tsx *.jsx *.md *.json *.jsonc'; then
            files_changed=true
            log_success "Files formatted with Deno"
        else
            log_info "Files already formatted"
        fi
    else
        log_error "deno fmt failed"
        exit 1
    fi
elif [ -f "package.json" ] && command -v prettier >/dev/null 2>&1; then
    # Node.js project - use prettier for JS/TS
    log_info "Formatting with prettier..."
    if prettier --write '**/*.{js,ts,tsx,jsx}' --print-width=100 --semi --single-quote=false; then
        if files_modified '*.js *.ts *.tsx *.jsx'; then
            files_changed=true
            log_success "JavaScript/TypeScript formatted"
        fi
    fi
fi

# For Deno projects, skip separate markdown formatting since deno fmt handles it
# Only do separate markdown formatting for non-Deno projects
if ! command -v deno >/dev/null 2>&1; then
    # Format Markdown with Prettier (only if not a Deno project)
    if command -v prettier >/dev/null 2>&1; then
        log_info "Formatting Markdown..."
        if prettier --write '**/*.md' --print-width=100 --prose-wrap=preserve; then
            if files_modified '*.md'; then
                files_changed=true
                log_success "Markdown formatted"
            else
                log_info "Markdown already formatted"
            fi
        fi
    else
        log_warn "prettier not found - install with: brew install prettier"
    fi
fi

# Format other languages based on project type
case "$(detect_project_type)" in
    "rust")
        if command -v cargo >/dev/null 2>&1; then
            log_info "Formatting Rust..."
            cargo fmt
            if files_modified '*.rs'; then
                files_changed=true
                log_success "Rust formatted"
            fi
        fi
        ;;
    "python")
        if command -v black >/dev/null 2>&1; then
            log_info "Formatting Python..."
            black .
            if files_modified '*.py'; then
                files_changed=true
                log_success "Python formatted"
            fi
        fi
        ;;
    "go")
        if command -v go >/dev/null 2>&1; then
            log_info "Formatting Go..."
            go fmt ./...
            if files_modified '*.go'; then
                files_changed=true
                log_success "Go formatted"
            fi
        fi
        ;;
esac

# Stage any changes
if [ "$files_changed" = true ]; then
    stage_changes
fi

exit 0
